<!DOCTYPE html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="target-densitydpi=low-dpi, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/><!-- default / black / black-translucent -->
<meta name="format-detection" content="telephone=no"/>
<title>cpuemu - Alpha1</title>
<meta property="og:image" content="cpuemu.png">
<link rel="apple-touch-icon" href="cpuemu.png"/>
<style>
body {
	font-family: sans-serif;
}
</style>
<script src="lib/fukuno.js"></script>
<script>"use strict";

var CPU = function() {
	this.r = []; // var:0-7, sp:13, link:14, pc:15
	this.status = {
		get: function() {
			var res = 0;
			res |= (this.n ? (1 << 31) : 0);
			res |= (this.z ? (1 << 30) : 0);
			res |= (this.c ? (1 << 29) : 0);
			res |= (this.v ? (1 << 28) : 0);
			res |= (this.q ? (1 << 27) : 0);
			res |= ((this.it & 3) << 25);
			res |= (this.j ? (1 << 24) : 0);
			res |= ((this.ge & 0xf) << 16);
			res |= ((this.it & 0xfc) << 8);
			res |= (this.E ? (1 << 9) : 0);
			res |= (this.A ? (1 << 8) : 0);
			res |= (this.I ? (1 << 7) : 0);
			res |= (this.F ? (1 << 6) : 0);
			res |= (this.t ? (1 << 5) : 0);
			res |= (this.mode & 0x1f);
			return res & 0xffffffff;
		},
		set: function(n) {
			this.n = (n & (1 << 31)) != 0;
			this.z = (n & (1 << 30)) != 0;
			this.c = (n & (1 << 29)) != 0;
			this.v = (n & (1 << 28)) != 0;
			this.q = (n & (1 << 27)) != 0;
			this.it = (((n >> 8) & 0xfc) | ((n >> 25) & 3));
			this.j = (n & (1 << 24)) != 0;
			this.ge = ((n >> 16) & 0xf);
			this.E = (n & (1 << 9)) != 0;
			this.A = (n & (1 << 8)) != 0;
			this.I = (n & (1 << 7)) != 0;
			this.F = (n & (1 << 6)) != 0;
			this.t = (n & (1 << 5)) != 0;
			this.mode = n & 0x1f;
		}
	};
	this.reset = function() {
		for (var i = 0; i < 16; i++)
			this.r[i] = 0;
		this.status.set(0);
	};
	this.reset();
	
	this.mem = {
		ram: [],
		check: function(ad, len) {
			for (var i = 0; i < len; i++) {
				if (isNaN(this.ram[ad + i])) return false;
			}
			return true;
		},
		get: function(ad) {
			if (isNaN(this.ram[ad])) return 0;
			return this.ram[ad];
		},
		set: function(ad, n) {
			this.ram[ad] = n;
		},
		get16: function(ad) {
			var n = this.get(ad);
			n |= this.get(ad + 1) << 8;
			return n;
		},
		set16: function(ad, n) {
			this.set(ad, n & 0xff);
			this.set(ad + 1, (n >> 8) & 0xff);
		},
		get32: function(ad) {
			var n = this.get16(ad);
			n |= this.get16(ad + 2) << 16;
			if (n < 0) n += 0x100000000;
			return n;
		},
		set32: function(ad, n) {
			this.set16(ad, n & 0xffff);
			this.set16(ad + 2, (n >> 16) & 0xffff);
		},
	};
	this.step = function() {
		var iaddr = this.r[15];
		if (iaddr === 0xDEADBEEE) { // 0xDEADBEEF & 0xfffffffe
			// instead of stopping execution at RET
			return 0;
		}
		if (iaddr % 2 != 0) {
			alert ("unaligned instructon read #" + iaddr.toString(16));
			return 0;
		}
		if (!this.mem.check(iaddr, 2) && get("uninitialized_memory").value === "halt") {
			alert("read instruction from uninitialized memory #" + iaddr.toString(16));
			return 0;
		}
		var code = this.mem.get16(iaddr);
//		this.code = code;
		this.r[15] += 2;
		if (this.r[15] >= 0x100000000) this.r[15] -= 0x100000000;
//		console.log(code.toString(2));
//		alert(code.toString(2));
		try {
			var chk = function(bin) {
				var n = parseInt(bin, 2);
				var c = code >> (16 - bin.length);
				return c == n;
			};
			var getu = function(start, n) {
				return (code >> start) & ((1 << n) - 1);
			};
			var getn = function(start, n) {
				var res = (code >> start) & ((1 << n) - 1);
				if ((res >> (n - 1)) != 0)
					return res - (1 << n);
				return res;
			};
			var norm = function(n) {
				var v = 0x100000000;
				while (n >= v) n -= v;
				while (n < 0) n += v;
				return n;
			};
			this.checkmem = function(addr, n, iswrite) {
				if (addr % n != 0) {
					throw "unaligned memory " + (iswrite ? "write" : "read") +
						" #" + addr.toString(16);
				}
				if (!iswrite && !this.mem.check(addr, n) &&
				get("uninitialized_memory").value === "halt") {
					throw "read from uninitialized memory #" + addr.toString(16);
				}
			};
			this.setflg = function(n) {
				this.status.z = n == 0;
				this.status.n = (n >> 31) != 0;
				return n;
			};
			if (chk("00100")) { // Rd = u8
				this.r[getu(8, 3)] = this.setflg(getu(0, 8));
			} else if (chk("01000110")) { // Rd = Rm
				var dstidx = getu(0, 3) | (getu(7, 1) << 3);
				var srcidx = getu(3, 4);
				var srcvalue;
				if (srcidx == 15) { // PC
					srcvalue = norm(this.r[srcidx] + 2); // PC + 4 = (PC + 2) + 2
				} else {
					srcvalue = this.r[srcidx];
				}
				if (dstidx == 15) { // PC
					this.r[dstidx] = norm(srcvalue & 0xfffffffe);
				} else {
					this.r[dstidx] = srcvalue;
				}
			} else if (chk("00110")) { // Rd += u8
				this.r[getu(8, 3)] = this.setflg(norm(this.r[getu(8, 3)] + getu(0, 8)));
			} else if (chk("00111")) { // Rd -= u8
				this.r[getu(8, 3)] = this.setflg(norm(this.r[getu(8, 3)] - getu(0, 8)));
			} else if (chk("10100")) { // Rd = PC + u8
				this.r[getu(8, 3)] = norm((this.r[15] + 2 + (getu(0, 8) << 2)) & 0xfffffffc);
			} else if (chk("01000100")) { // Rd += Rm
				var dstidx = getu(0, 3) | (getu(7, 1) << 3);
				var srcidx = getu(3, 4);
				if (srcidx == 15 && dstidx == 15) {
					throw "Rd += Rm with both PC isn't allowed";
				}
				var srcvalue;
				if (srcidx == 15) { // PC
					srcvalue = norm(this.r[srcidx] + 2); // PC + 4 = (PC + 2) + 2
				} else {
					srcvalue = this.r[srcidx];
				}
				if (dstidx == 15) { // PC
					this.r[dstidx] = norm((this.r[dstidx] + 2 + srcvalue) & 0xfffffffe);
				} else {
					this.r[dstidx] = norm(this.r[dstidx] + srcvalue);
				}
			} else if (chk("0001110")) { // Rd = Rn + u3
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(3, 3)] + getu(6, 3)));
			} else if (chk("0001111")) { // Rd = Rn - u3
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(3, 3)] - getu(6, 3)));
			} else if (chk("0001100")) { // Rd = Rn + Rm
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(3, 3)] + this.r[getu(6, 3)]));
			} else if (chk("0001101")) { // Rd = Rn - Rm
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(3, 3)] - this.r[getu(6, 3)]));
			} else if (chk("0100001001")) { // Rd = -Rm
				this.r[getu(0, 3)] = this.setflg(norm(-this.r[getu(3, 3)]));
			} else if (chk("0100001101")) { // Rd *= Rm
				// don't do this.r[getu(0, 3)] * this.r[getu(3, 3)], or the result will be inaccurate
				var ret = 0;
				var val = this.r[getu(0, 3)];
				var mult = this.r[getu(3, 3)];
				for (var i = 0; i < 32; i++) {
					if (mult & 1) ret = norm(ret + val);
					val = norm(val + val);
					mult >>>= 1;
				}
				this.r[getu(0, 3)] = this.setflg(ret);
			} else if (chk("00000")) { // Rd = Rm << u5
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(3, 3)] << getu(6, 5)));
			} else if (chk("00001")) { // Rd = Rm >> u5
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(3, 3)] >>> getu(6, 5)));
			} else if (chk("0100000010")) { // Rd <<= Rs
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(0, 3)] << this.r[getu(3, 3)]));
			} else if (chk("0100000011")) { // Rd >>= Rs
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(0, 3)] >>> this.r[getu(3, 3)]));
			} else if (chk("0100001111")) { // Rd = ~Rm
				this.r[getu(0, 3)] = this.setflg(norm(~this.r[getu(3, 3)]));
			} else if (chk("0100000000")) { // Rd &= Rm
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(0, 3)] & this.r[getu(3, 3)]));
			} else if (chk("0100001100")) { // Rd |= Rm
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(0, 3)] | this.r[getu(3, 3)]));
			} else if (chk("0100000001")) { // Rd ^= Rm
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(0, 3)] ^ this.r[getu(3, 3)]));
			} else if (chk("01111")) { // Rd = [Rn + u5]
				var addr = norm(this.r[getu(3, 3)] + getu(6, 5));
				this.checkmem(addr, 1, false);
				this.r[getu(0, 3)] = this.mem.get(addr);
			} else if (chk("10001")) { // Rd = [Rn + u5]W
				var addr = norm(this.r[getu(3, 3)] + getu(6, 5) * 2);
				this.checkmem(addr, 2, false);
				this.r[getu(0, 3)] = this.mem.get16(addr);
			} else if (chk("01101")) { // Rd = [Rn + u5]L
				var addr = norm(this.r[getu(3, 3)] + getu(6, 5) * 4);
				this.checkmem(addr, 4, false);
				this.r[getu(0, 3)] = this.mem.get32(addr);
			} else if (chk("01001")) { // Rd = [PC + u8]L
				var addr = norm((this.r[15] + 2 + getu(0, 8) * 4) & 0xfffffffc);
				this.checkmem(addr, 4, false);
				this.r[getu(8, 3)] = this.mem.get32(addr);
			} else if (chk("0101110")) { // Rd = [Rn + Rm]
				var addr = norm(this.r[getu(3, 3)] + this.r[getu(6, 3)]);
				this.checkmem(addr, 1, false);
				this.r[getu(0, 3)] = this.mem.get(addr);
			} else if (chk("0101011")) { // Rd = [Rn + Rm]C
				var addr = norm(this.r[getu(3, 3)] + this.r[getu(6, 3)]);
				this.checkmem(addr, 1, false);
				var value = this.mem.get(addr);
				if (value & 0x80) value = norm(value | 0xffffff00);
				this.r[getu(0, 3)] = value;
			} else if (chk("0101101")) { // Rd = [Rn + Rm]W
				var addr = norm(this.r[getu(3, 3)] + this.r[getu(6, 3)]);
				this.checkmem(addr, 2, false);
				this.r[getu(0, 3)] = this.mem.get16(addr);
			} else if (chk("0101111")) { // Rd = [Rn + Rm]S
				var addr = norm(this.r[getu(3, 3)] + this.r[getu(6, 3)]);
				this.checkmem(addr, 2, false);
				var value = this.mem.get16(addr);
				if (value & 0x8000) value = norm(value | 0xffff0000);
				this.r[getu(0, 3)] = value;
			} else if (chk("0101100")) { // Rd = [Rn + Rm]L
				var addr = norm(this.r[getu(3, 3)] + this.r[getu(6, 3)]);
				this.checkmem(addr, 4, false);
				this.r[getu(0, 3)] = this.mem.get32(addr);
			} else if (chk("01110")) { // [Rn + u5] = Rd
				var addr = norm(this.r[getu(3, 3)] + getu(6, 5));
				this.checkmem(addr, 1, true);
				this.mem.set(addr, this.r[getu(0, 3)]);
			} else if (chk("10000")) { // [Rn + u5]W = Rd
				var addr = norm(this.r[getu(3, 3)] + getu(6, 5) * 2);
				this.checkmem(addr, 2, true);
				this.mem.set16(addr, this.r[getu(0, 3)]);
			} else if (chk("01100")) { // [Rn + u5]L = Rd
				var addr = norm(this.r[getu(3, 3)] + getu(6, 5) * 4);
				this.checkmem(addr, 4, true);
				this.mem.set32(addr, this.r[getu(0, 3)]);
			} else if (chk("0101010")) { // [Rn + Rm] = Rd
				var addr = norm(this.r[getu(3, 3)] + this.r[getu(6, 3)]);
				this.checkmem(addr, 1, true);
				this.mem.set(addr, this.r[getu(0, 3)]);
			} else if (chk("0101001")) { // [Rn + Rm]W = Rd
				var addr = norm(this.r[getu(3, 3)] + this.r[getu(6, 3)]);
				this.checkmem(addr, 2, true);
				this.mem.set16(addr, this.r[getu(0, 3)]);
			} else if (chk("0101000")) { // [Rn + Rm]L = Rd
				var addr = norm(this.r[getu(3, 3)] + this.r[getu(6, 3)]);
				this.checkmem(addr, 4, true);
				this.mem.set32(addr, this.r[getu(0, 3)]);
			} else if (chk("00101")) { // Rn - u8
				this.setflg(norm(this.r[getu(8, 3)] - getu(0, 8)));
			} else if (chk("0100001010")) { // Rn - Rm
				this.setflg(norm(this.r[getu(0, 3)] - this.r[getu(3, 3)]));
			} else if (chk("0100001000")) { // Rn & Rm
				this.setflg(norm(this.r[getu(0, 3)] & this.r[getu(3, 3)]));
			} else if (chk("1101")) { // IF cond GOTO n8
				var taken = false;
				switch (getu(9, 3)) {
					case 0: taken = this.status.z; break;
					case 1: taken = this.status.c; break;
					case 2: taken = this.status.n; break;
					case 3: taken = this.status.v; break;
					case 4: taken = !this.status.z && this.status.c; break;
					case 5: taken = this.status.n === this.status.v; break;
					case 6: taken = !this.status.z && this.status.n === this.status.v; break;
					case 7: taken = true; break; // this is BKPT / Unpredictable
				}
				if (getu(8, 1)) taken = !taken;
				if (taken) // not +2 because PC+=2 is done already
					this.r[15] = norm(this.r[15] + ((getn(0, 8) + 1) << 1));
			} else if (chk("11100")) { // GOTO n11
				// not +2 because PC+=2 is done already
				this.r[15] = norm(this.r[15] + ((getn(0, 11) + 1) << 1));
			} else if (chk("01000111")) { // GOTO Rm / GOSUB Rm
				var isgosub = getu(7, 1) === 1;
				var iname = isgosub ? "GOSUB" : "GOTO";
				if (getu(0, 3) !== 0) throw "instruction like " + iname + " Rm, but last 3 bits are not `000";
				var srcidx = getu(3, 4);
				if (srcidx === 13) throw "using SP for " + iname + " Rm is prohibited";
				if (srcidx === 15) throw "using PC for " + iname + " Rm is prohibited";
				if ((this.r[srcidx] & 1) === 0) {
//					if (!isgosub && srcidx == 14) { // RET
//						alert("ret");
//						return 0;
//					}
					throw "0 is passed as the LSB of the operand of " + iname + " Rm";
				}
				if (isgosub) this.r[14] = norm(this.r[15] | 1);
				this.r[15] = norm(this.r[srcidx] & 0xfffffffe);
			} else if (chk("11110")) { // GOSUB n22
				var upper = getn(0, 11);
				if (!this.mem.check(this.r[15], 2) && get("uninitialized_memory").value === "halt") {
					alert("read instruction from uninitialized memory #" + this.r[15].toString(16));
					return 0;
				}
				var inst2 = this.mem.get16(this.r[15]);
				if (((inst2 >> 11) & 0x1f) !== 0x1f) {
					throw "partial GOSUB n22 instruction";
				}
				var lower = inst2 & 0x7ff;
				var delta = (upper << 11) | lower;
				this.r[14] = norm((this.r[15] + 2) | 1);
				this.r[15] = norm(this.r[15] + 2 + delta * 2);
			} else if (chk("0100001110")) { // BIC Rd, Rm (Rd &= ~Rm)
				this.r[getu(0, 3)] = this.setflg(norm(this.r[getu(0, 3)] & ~this.r[getu(3, 3)]));
			} else {
				if (get("unsupported_op").value === "halt") {
					throw "unsupported instruction";
				}
			}
		} catch(e) {
			var inst = code.toString(2);
			while (inst.length < 16) inst = "0" + inst;
			alert("" + e + "\n\ninstruction address: #" + iaddr.toString(16) +
				"\ninstruction: " + inst);
			return 0;
		}
//		dump(this.r);
		return 1;
	};
};

window.onload = function() {
	var cpu = new CPU();
	
	for (var i = 0; i < 16; i++) {
		var r = create("div");
		r.textContent = "R" + i + ": ";
		r.ondblclick = (function(idx) {
			return function() {
				var rawRes = prompt("R" + idx + "の値を入力", cpu.r[idx]);
				if (rawRes !== null) {
					rawRes = rawRes.replace(/\s+/g, "");
					var res;
					if (rawRes.substr(0, 1) == '`') {
						res = parseInt(rawRes.substr(1), 2);
					} else if (rawRes.substr(0, 1) == '#') {
						res = parseInt(rawRes.substr(1), 16);
					} else {
						res = parseInt(rawRes);
					}
					if (!isNaN(res)) {
						res = res & 0xffffffff;
						if (res < 0) res += 0x100000000;
						cpu.r[idx] = res;
						showRegs();
					}
				}
			};
		})(i);
		get("regs").appendChild(r);
	}
	var flgnames = ["Negative", "Zero", "Carry", "Overflow"];
	for (var i = 0; i < 4; i++) {
		var r = create("div");
		r.textContent = flgnames[i] + "-flg: ";
		get("regs").appendChild(r);
	}
	var showRegs = function() {
		var rs = get("regs").childNodes;
		for (var i = 0; i < 16; i++) {
			var negative = "";
			if (cpu.r[i] & 0x80000000) {
				negative = " (" + (cpu.r[i] - 0x100000000) + ")";
			}
			rs[i].textContent = "R" + i + ": " + cpu.r[i] + negative + " #" + cpu.r[i].toString(16);
		}
		rs[16].textContent = flgnames[0] + "-flg: " + cpu.status.n;
		rs[17].textContent = flgnames[1] + "-flg: " + cpu.status.z;
		rs[18].textContent = flgnames[2] + "-flg: " + cpu.status.c;
		rs[19].textContent = flgnames[3] + "-flg: " + cpu.status.v;
	};
	
	var reset = function() {
		cpu.reset();
		cpu.r[1] = 0x100;
		cpu.r[13] = 0x1000; // SP
		cpu.r[14] = 0xDEADBEEF; // LR
		cpu.r[15] = 0; // PC
		cpu.mem.ram = [];
		autoflg = false;
		get("auto").textContent = "START";
		
		var s = get("prog").value.split("\n");
		var n = 0;
		var parse = function(n) {
			var s = "";
			for (var i = 0; i < n.length; i++) {
				if (n.charAt(i) == "0" || n.charAt(i) == "1")
					s += n.charAt(i);
			}
			return s;
		};
		for (var i = 0; i < s.length; i++) {
			var code = parse(s[i]);
			if (code.length == 16) {
				cpu.mem.set16(n * 2, parseInt(code, 2));
				n++;
			}
		}
		showRegs();
	};
	var autoflg = false;
	var auto = function() {
		if (autoflg) {
			autoflg = false;
			get("auto").textContent = "START";
			return;
		} else {
			autoflg = true;
			get("auto").textContent = "STOP";
		}
		var autostep = function() {
			if (!autoflg)
				return;
			if (cpu.step()) {
				setTimeout(autostep, get("autostep_interval").value);
			} else {
				autoflg = false;
				get("auto").textContent = "START";
			}
			showRegs();
		};
		autostep();
	};
	
	get("reset").onclick = reset;
	get("step").onclick = function() {
		autoflg = false;
		get("auto").textContent = "START";
		cpu.step();
		showRegs();
	};
	get("auto").onclick = auto;
	reset();
};

</script>
<style>
#credit {
	margin-top: 20px;
}
#prog {
	height: 400px;
	width: 14em;
	display: inline-block;
	font-size: 14px;
}
#regs {
	height: 400px;
	display: inline-block;
	font-size: 14px;
	vertical-align: top;
}
#config {
	margin-top: 1em;
	margin-bottom: 1em;
	font-size: 14px;
}
#main {
	padding: .5em;
}
a {
	color: #333 !important;
}
</style>
</head>
<body>

<h1>cpuemu - Alpha1</h1>
<div id=main>
使えるマシン語一覧: <a href=http://fukuno.jig.jp/1188>IchigoJamではじめるARMマシン語その3</a><br>
<br><textarea id=prog>0010001100001001
0000001000011011
0101010001011011
0011001100000001
0000101000011010
0010101000001010
1101000111111010
0100011101110000
</textarea>
<div id=regs></div>
<br>
<button id=auto>START</button>
<button id=step>STEP</button>
<button id=reset>RESET</button>
</div>
<div id="config">
未サポートの命令<select id="unsupported_op">
<option value="ignore">を無視</option>
<option value="halt" selected="selected">で停止</option>
</select><br>
未初期化のメモリを読んだら<select id="uninitialized_memory">
<option value="zero">0とみなす</option>
<option value="halt" selected="selected">停止する</option>
</select><br>
自動実行の速さは<select id="autostep_interval">
<option value="10">高速</option>
<option value="100" selected="selected">通常</option>
</select>
</div>
<div id='credit'>
cpuemu a1 (for <a href=http://ichigojam.net/>IchigoJam</a>)<br>
<a href="https://ichigojam.github.io/asm15/cpuemu.html">Original</a> APP: <a href='http://fukuno.jig.jp/1328'>CC BY fukuno.jig.jp</a><br>
Modified By みけCAT<br>
Modification: <a href="https://creativecommons.org/licenses/by/4.0/deed.ja">CC BY 4.0</a> by みけCAT
</div>

</body>
<html>
